<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
  <meta http-equiv="Content-Security-Policy" content="default-src *; script-src * 'unsafe-inline' 'unsafe-eval'; style-src * 'unsafe-inline';">
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ÙØµÙˆÙ„ÙŠ - Ø£ÙˆÙ„ÙŠØ§Ø¡ Ø§Ù„Ø£Ù…ÙˆØ±</title>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;700;800;900&display=swap" rel="stylesheet">
<style>
:root{--bg:#0a0f1e;--card:#111827;--accent:#f0b429;--accent2:#e05a2b;--purple:#7c3aed;--green:#10b981;--text:#f0eaff;--muted:#8b7aa8;--red:#ef4444;--blue:#3b82f6;}
*{margin:0;padding:0;box-sizing:border-box;}
body{font-family:'Tajawal',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;background-image:radial-gradient(ellipse at 30% 10%,#1a2a5e33 0%,transparent 60%),radial-gradient(ellipse at 70% 90%,#1a3a2e22 0%,transparent 60%);}
.corner-label{position:fixed;bottom:1rem;font-size:0.75rem;font-weight:700;color:rgba(200,180,255,0.55);z-index:500;pointer-events:none;line-height:1.5;}
.corner-left{left:0.8rem;text-align:right;} .corner-right{right:0.8rem;text-align:left;}
.school-banner{text-align:center;padding:1.3rem 1rem 0.9rem;background:linear-gradient(180deg,#0d1526 0%,transparent 100%);border-bottom:1px solid #ffffff0d;}
.school-name{font-size:1.5rem;font-weight:900;background:linear-gradient(135deg,#c9a227,#f0e68c,#b8860b);-webkit-background-clip:text;-webkit-text-fill-color:transparent;display:inline-block;}
.school-name::before,.school-name::after{content:'âœ¦';font-size:0.85rem;margin:0 0.45rem;background:linear-gradient(135deg,#c9a227,#f0e68c);-webkit-background-clip:text;-webkit-text-fill-color:transparent;}
.subject-line{margin-top:0.28rem;font-size:0.95rem;font-weight:900;}
.s1{color:#f0b429;}.s2{color:#e05a2b;}.s3{color:#10b981;}.s4{color:#3b82f6;}.s5{color:#a78bfa;}.s6{color:#ec4899;}.s7{color:#f59e0b;}.s8{color:#06b6d4;}.s9{color:#84cc16;}.s10{color:#f43f5e;}.s11{color:#8b5cf6;}.s12{color:#14b8a6;}
.readonly-badge{display:inline-block;background:#10b98122;color:var(--green);border:1px solid #10b98133;border-radius:20px;padding:0.18rem 0.75rem;font-size:0.73rem;font-weight:700;margin-top:0.4rem;}
#loginScreen{padding:2rem 1.5rem;max-width:420px;margin:0 auto;text-align:center;}
#loginScreen h1{font-size:1.9rem;font-weight:900;background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:0.35rem;}
#loginScreen p{color:var(--muted);margin-bottom:1.2rem;font-size:0.9rem;}
.login-box{background:var(--card);border:2px solid #ffffff12;border-radius:20px;padding:1.8rem;margin-bottom:1rem;}
.login-box h2{font-size:1.05rem;font-weight:800;margin-bottom:1.1rem;color:var(--accent);}
.classes-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:0.65rem;margin-bottom:1.2rem;}
.class-opt{background:#ffffff08;border:2px solid #ffffff12;border-radius:12px;padding:0.8rem 0.4rem;font-family:'Tajawal',sans-serif;font-size:1rem;font-weight:800;color:var(--muted);cursor:pointer;transition:all 0.2s;text-align:center;}
.class-opt:hover{border-color:var(--accent);color:var(--accent);}
.class-opt.selected{border-color:var(--accent);color:var(--accent);background:#f0b42918;}
.sid-input{width:100%;background:#ffffff08;border:2px solid #ffffff18;border-radius:12px;color:var(--text);font-family:'Tajawal',sans-serif;font-size:1.05rem;padding:0.75rem 1.1rem;outline:none;text-align:center;letter-spacing:2px;direction:ltr;margin-bottom:0.8rem;transition:border-color 0.2s;}
.sid-input:focus{border-color:var(--accent);}
.sid-input::placeholder{color:var(--muted);letter-spacing:0;direction:rtl;}
.login-btn{width:100%;background:linear-gradient(135deg,var(--accent),var(--accent2));color:#fff;border:none;border-radius:12px;padding:0.82rem;font-family:'Tajawal',sans-serif;font-size:1rem;font-weight:700;cursor:pointer;transition:opacity 0.2s;}
.login-btn:hover{opacity:0.9;}
.login-err{color:#ef4444;font-size:0.82rem;margin-top:0.5rem;min-height:1.1rem;}
#studentView{display:none;max-width:580px;margin:0 auto;padding:1.2rem 1.2rem 5rem;}
.back-btn{background:none;border:2px solid #ffffff20;color:var(--muted);border-radius:10px;padding:0.3rem 0.8rem;font-family:'Tajawal',sans-serif;font-size:0.82rem;font-weight:700;cursor:pointer;margin-bottom:1rem;transition:all 0.2s;}
.back-btn:hover{border-color:var(--accent);color:var(--accent);}
.student-hero{background:linear-gradient(135deg,#1a103a,#0f1a30);border:2px solid #ffffff12;border-radius:20px;padding:1.8rem;text-align:center;margin-bottom:1.2rem;position:relative;overflow:hidden;}
.student-hero::before{content:'';position:absolute;inset:0;background:radial-gradient(ellipse at center,#7c3aed0a 0%,transparent 70%);}
.hero-name{font-size:2rem;font-weight:900;background:linear-gradient(135deg,var(--accent),var(--accent2));-webkit-background-clip:text;-webkit-text-fill-color:transparent;position:relative;}
.hero-class{font-size:0.85rem;color:var(--muted);margin-top:0.3rem;}
.live-badge{display:inline-flex;align-items:center;gap:0.35rem;background:#10b98115;color:var(--green);border:1px solid #10b98133;border-radius:20px;padding:0.22rem 0.75rem;font-size:0.76rem;font-weight:700;margin-top:0.5rem;}
/* NOTIFICATIONS */
.notif-section{background:linear-gradient(135deg,#1a1030,#0f1525);border:2px solid #f0b42933;border-radius:16px;padding:1rem 1.1rem;margin-bottom:1rem;}
.notif-section h3{font-size:0.95rem;font-weight:800;color:var(--accent);margin-bottom:0.7rem;display:flex;align-items:center;gap:0.4rem;}
.notif-item{background:#ffffff08;border-radius:12px;padding:0.65rem 0.85rem;margin-bottom:0.45rem;display:flex;align-items:center;gap:0.65rem;border:1px solid #ffffff0a;animation:slideIn 0.3s ease;}
.notif-item.unread{border-color:#f0b42933;background:#f0b42910;}
.notif-emoji{font-size:1.5rem;flex-shrink:0;}
.notif-text{flex:1;font-size:0.85rem;font-weight:700;line-height:1.5;}
.notif-date{font-size:0.7rem;color:var(--muted);}
.notif-empty{text-align:center;color:var(--muted);font-size:0.85rem;padding:1rem 0;}
@keyframes slideIn{from{opacity:0;transform:translateX(15px)}to{opacity:1;transform:translateX(0)}}
.live-dot{width:6px;height:6px;border-radius:50%;background:var(--green);animation:pulse 1.5s ease infinite;}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:0.3}}
.stats-cards{display:grid;grid-template-columns:1fr 1fr;gap:0.8rem;margin-bottom:1.2rem;}
.stat-card{background:var(--card);border-radius:16px;padding:1.2rem;text-align:center;border:2px solid #ffffff10;}
.stat-card.gold{border-color:#f0b42944;}
.stat-card.green{border-color:#10b98144;}
.stat-num{font-size:2.8rem;font-weight:900;line-height:1;}
.stat-num.gold{color:var(--accent);}
.stat-num.green{color:var(--green);}
.stat-label{font-size:0.8rem;color:var(--muted);margin-top:0.3rem;}
.rank-badge{background:linear-gradient(135deg,var(--accent),var(--accent2));color:#000;border-radius:12px;padding:0.55rem 1.2rem;font-size:1rem;font-weight:900;display:inline-block;margin-top:0.5rem;}
.badge-row{display:flex;flex-wrap:wrap;gap:0.3rem;justify-content:center;margin-top:0.6rem;}
.badge{display:inline-flex;align-items:center;gap:0.2rem;border-radius:20px;padding:0.18rem 0.6rem;font-size:0.75rem;font-weight:800;border:1px solid transparent;}
.badge-gold{background:#f0b42920;color:#f0b429;border-color:#f0b42944;}
.badge-green{background:#10b98120;color:#10b981;border-color:#10b98144;}
.badge-purple{background:#7c3aed20;color:#a78bfa;border-color:#7c3aed44;}
.badge-red{background:#ef444420;color:#f87171;border-color:#ef444444;}
.badge-cyan{background:#06b6d420;color:#22d3ee;border-color:#06b6d444;}
.section-card{background:var(--card);border-radius:16px;padding:1.2rem;margin-bottom:1rem;border:2px solid #ffffff10;}
.section-card h3{font-size:1rem;font-weight:800;margin-bottom:0.8rem;color:var(--accent);}
.bhv-item{display:flex;align-items:center;gap:0.6rem;padding:0.6rem;background:#ffffff06;border-radius:10px;margin-bottom:0.4rem;}
.bhv-emoji{font-size:1.3rem;}
.bhv-text{font-size:0.88rem;color:var(--text);}
.empty-note{color:var(--muted);font-size:0.85rem;text-align:center;padding:0.8rem;}
.group-display{display:flex;align-items:center;gap:0.6rem;padding:0.7rem 1rem;background:#ffffff06;border-radius:12px;}
.group-dot{width:12px;height:12px;border-radius:50%;flex-shrink:0;}
.group-name{font-size:0.95rem;font-weight:700;}
.loading{text-align:center;padding:2.5rem;color:var(--muted);}
.spinner{width:38px;height:38px;border:3px solid #ffffff12;border-top-color:var(--accent);border-radius:50%;animation:spin 0.8s linear infinite;margin:0 auto 1rem;}
@keyframes spin{to{transform:rotate(360deg)}}
.feedback-section{background:var(--card);border-radius:16px;padding:1.2rem;margin-bottom:1rem;border:2px solid #7c3aed33;}
.feedback-section h3{font-size:1rem;font-weight:800;margin-bottom:0.8rem;color:var(--purple);}
.feedback-type-row{display:flex;gap:0.45rem;margin-bottom:0.8rem;flex-wrap:wrap;}
.feedback-type-btn{background:#ffffff08;border:2px solid #ffffff12;border-radius:10px;padding:0.4rem 0.75rem;font-family:'Tajawal',sans-serif;font-size:0.82rem;font-weight:700;color:var(--muted);cursor:pointer;transition:all 0.2s;}
.feedback-type-btn:hover{border-color:var(--purple);color:var(--purple);}
.feedback-type-btn.active{border-color:var(--purple);color:var(--purple);background:#7c3aed18;}
.feedback-textarea{width:100%;background:#ffffff08;border:2px solid #ffffff15;border-radius:12px;color:var(--text);font-family:'Tajawal',sans-serif;font-size:0.9rem;padding:0.75rem;outline:none;resize:vertical;min-height:90px;transition:border-color 0.2s;margin-bottom:0.7rem;}
.feedback-textarea:focus{border-color:var(--purple);}
.feedback-textarea::placeholder{color:var(--muted);}
.feedback-submit{width:100%;background:linear-gradient(135deg,var(--purple),#5b21b6);color:#fff;border:none;border-radius:12px;padding:0.72rem;font-family:'Tajawal',sans-serif;font-size:0.95rem;font-weight:700;cursor:pointer;transition:opacity 0.2s;}
.feedback-submit:hover{opacity:0.9;}
.feedback-submit:disabled{opacity:0.5;cursor:not-allowed;}
.feedback-success{background:#10b98118;border:1px solid #10b98133;border-radius:10px;padding:0.7rem;text-align:center;color:var(--green);font-size:0.85rem;font-weight:700;margin-top:0.5rem;display:none;}
.feedback-success.show{display:block;}
.prev-feedbacks{margin-top:0.9rem;border-top:1px solid #ffffff0d;padding-top:0.8rem;}
.prev-feedbacks-title{font-size:0.82rem;color:var(--muted);margin-bottom:0.6rem;font-weight:700;}
.fb-item{background:#ffffff06;border-radius:10px;padding:0.7rem;margin-bottom:0.45rem;border-right:3px solid var(--purple);}
.fb-item-type{font-size:0.72rem;font-weight:700;color:var(--purple);margin-bottom:0.25rem;display:inline-block;background:#7c3aed15;padding:0.1rem 0.45rem;border-radius:6px;}
.fb-item-text{font-size:0.85rem;color:var(--text);line-height:1.6;}
.fb-item-date{font-size:0.7rem;color:var(--muted);margin-top:0.3rem;}
.fb-empty{color:var(--muted);font-size:0.82rem;text-align:center;padding:0.5rem;}
.toast{position:fixed;bottom:2rem;left:50%;transform:translateX(-50%) translateY(100px);background:var(--green);color:white;padding:0.65rem 1.5rem;border-radius:50px;font-weight:700;font-size:0.88rem;transition:transform 0.3s;z-index:9999;white-space:nowrap;}
.toast.show{transform:translateX(-50%) translateY(0);}
.toast.error{background:var(--red);}
</style>
</head>
<body>

<div class="corner-label corner-left">ØªØ·ÙˆÙŠØ± Ø§Ù„Ù…Ø¹Ù„Ù…<br><span style="color:rgba(167,139,250,0.65)">Ø£. Ø¹Ù„ÙŠ Ø§Ù„Ø²Ù‡Ø±Ø§Ù†ÙŠ</span></div>
<div class="corner-label corner-right">Ù…Ø¯ÙŠØ± Ø§Ù„Ù…Ø¯Ø±Ø³Ø©<br><span style="color:rgba(167,139,250,0.65)">Ø£. ØªØ±ÙƒÙŠ Ø§Ù„Ø±ÙˆÙŠØ³</span></div>

<div class="school-banner">
  <div class="school-name">Ù…Ø¯Ø±Ø³Ø© Ø§Ø¨Ù† ØªÙŠÙ…ÙŠØ©</div>
  <div class="subject-line">ğŸ’» <span class="s1">Ù…</span><span class="s2">Ø§</span><span class="s3">Ø¯</span><span class="s4">Ø©</span> <span class="s5">Ø§</span><span class="s6">Ù„</span><span class="s7">Ù…</span><span class="s8">Ù‡</span><span class="s9">Ø§</span><span class="s10">Ø±</span><span class="s11">Ø§</span><span class="s12">Øª</span> <span class="s1">Ø§</span><span class="s2">Ù„</span><span class="s3">Ø±</span><span class="s4">Ù‚</span><span class="s5">Ù…</span><span class="s6">ÙŠ</span><span class="s7">Ø©</span></div>
  <div><span class="readonly-badge">ğŸ‘ï¸ Ø¨ÙˆØ§Ø¨Ø© Ø£ÙˆÙ„ÙŠØ§Ø¡ Ø§Ù„Ø£Ù…ÙˆØ±</span></div>
</div>

<div id="loginScreen">
  <h1>ğŸ‘¨â€ğŸ‘©â€ğŸ‘§ Ø¨ÙˆØ§Ø¨Ø© Ø£ÙˆÙ„ÙŠØ§Ø¡ Ø§Ù„Ø£Ù…ÙˆØ±</h1>
  <p>Ø£Ø¯Ø®Ù„ ÙØµÙ„ Ø§Ø¨Ù†Ùƒ ÙˆØ±Ù‚Ù… Ø³Ø¬Ù„Ù‡ Ø§Ù„Ù…Ø¯Ù†ÙŠ Ù„Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§ØªÙ‡</p>
  <div class="login-box">
    <h2>1. Ø§Ø®ØªØ± Ø§Ù„ÙØµÙ„</h2>
    <div class="classes-grid">
      <div class="class-opt" onclick="selectLoginClass('Ø³Ø§Ø¯Ø³-Ø£','Ø³Ø§Ø¯Ø³ Ø£',this)">Ø³Ø§Ø¯Ø³ Ø£</div>
      <div class="class-opt" onclick="selectLoginClass('Ø³Ø§Ø¯Ø³-Ø¨','Ø³Ø§Ø¯Ø³ Ø¨',this)">Ø³Ø§Ø¯Ø³ Ø¨</div>
      <div class="class-opt" onclick="selectLoginClass('Ø®Ø§Ù…Ø³-Ø£','Ø®Ø§Ù…Ø³ Ø£',this)">Ø®Ø§Ù…Ø³ Ø£</div>
      <div class="class-opt" onclick="selectLoginClass('Ø®Ø§Ù…Ø³-Ø¨','Ø®Ø§Ù…Ø³ Ø¨',this)">Ø®Ø§Ù…Ø³ Ø¨</div>
      <div class="class-opt" onclick="selectLoginClass('Ø±Ø§Ø¨Ø¹-Ø£','Ø±Ø§Ø¨Ø¹ Ø£',this)">Ø±Ø§Ø¨Ø¹ Ø£</div>
      <div class="class-opt" onclick="selectLoginClass('Ø±Ø§Ø¨Ø¹-Ø¨','Ø±Ø§Ø¨Ø¹ Ø¨',this)">Ø±Ø§Ø¨Ø¹ Ø¨</div>
    </div>
    <h2 style="margin-bottom:0.8rem;">2. Ø£Ø¯Ø®Ù„ Ø±Ù‚Ù… Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¯Ù†ÙŠ</h2>
    <input class="sid-input" type="text" id="sidInput" placeholder="Ø±Ù‚Ù… Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¯Ù†ÙŠ Ù„Ù„Ø·Ø§Ù„Ø¨" maxlength="14">
    <button class="login-btn" onclick="loginParent()">Ø¹Ø±Ø¶ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ø§Ù„Ø¨ ğŸ”</button>
    <div class="login-err" id="loginErr"></div>
  </div>
</div>

<div id="studentView">
  <button class="back-btn" onclick="goBack()">â† Ø±Ø¬ÙˆØ¹</button>
  <div id="studentContent"><div class="loading"><div class="spinner"></div>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div></div>
</div>

<div class="toast" id="toast"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-app.js";
import { getFirestore, doc, onSnapshot, collection, addDoc, query, where, getDocs, orderBy, limit, updateDoc } from "https://www.gstatic.com/firebasejs/11.0.0/firebase-firestore.js";

const FC = {apiKey:"AIzaSyCjvGgB2AbabCiUiZ_Y-tOdacOI82KpX24",authDomain:"myclass1-app.firebaseapp.com",projectId:"myclass1-app",storageBucket:"myclass1-app.firebasestorage.app",messagingSenderId:"542052243338",appId:"1:542052243338:web:1baa9d295b4291d5c91a73"};
const db = getFirestore(initializeApp(FC));

const BADGES=[
  {id:'first',   emoji:'ğŸ¥‡',label:'Ø§Ù„Ø£ÙˆÙ„',      cls:'badge-gold',  check:(s,all)=>all.length>1&&[...all].sort((a,b)=>b.points-a.points)[0].id===s.id},
  {id:'top3',    emoji:'ğŸ…',label:'Ù…Ù† Ø§Ù„Ø£ÙˆØ§Ø¦Ù„', cls:'badge-gold',  check:(s,all)=>all.length>3&&[...all].sort((a,b)=>b.points-a.points).slice(0,3).some(x=>x.id===s.id)},
  {id:'best_bhv',emoji:'ğŸ˜‡',label:'Ø£ÙØ¶Ù„ Ø³Ù„ÙˆÙƒ', cls:'badge-green', check:(s,all)=>all.length>1&&(s.bhvPoints||0)>0&&[...all].sort((a,b)=>(b.bhvPoints||0)-(a.bhvPoints||0))[0].id===s.id},
  {id:'clean',   emoji:'ğŸ•Šï¸',label:'Ø³Ù„ÙˆÙƒ Ù†Ø¸ÙŠÙ', cls:'badge-green', check:(s)=>(!s.behaviors||s.behaviors.length===0)},
  {id:'active',  emoji:'ğŸ”¥',label:'Ù†Ø´ÙŠØ·',       cls:'badge-red',   check:(s)=>s.points>=10},
  {id:'star',    emoji:'â­',label:'Ù†Ø¬Ù…',         cls:'badge-gold',  check:(s)=>s.points>=20},
  {id:'legend',  emoji:'ğŸ‘‘',label:'Ø£Ø³Ø·ÙˆØ±Ø©',      cls:'badge-purple',check:(s)=>s.points>=50},
  {id:'bhv10',   emoji:'âœ¨',label:'10 Ø³Ù„ÙˆÙƒ',     cls:'badge-cyan',  check:(s)=>(s.bhvPoints||0)>=10},
];
function renderBadges(s,all){
  const bs=BADGES.filter(b=>b.check(s,all));
  if(!bs.length)return '';
  return `<div class="badge-row">${bs.map(b=>`<span class="badge ${b.cls}">${b.emoji} ${b.label}</span>`).join('')}</div>`;
}

const BB = [
  {id:'play',label:'Ø§Ù„Ù„Ø¹Ø¨ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ØµØ©',emoji:'ğŸ®'},
  {id:'talk',label:'Ø§Ù„Ø­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠ',emoji:'ğŸ’¬'},
  {id:'fight',label:'Ù…Ø´Ø§Ø¬Ø±Ø© Ø¯Ø§Ø®Ù„ Ø§Ù„ÙØµÙ„',emoji:'ğŸ¤¼'},
  {id:'sleep',label:'Ø§Ù„Ù†ÙˆÙ… Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ØµØ©',emoji:'ğŸ˜´'},
  {id:'eat',label:'Ø§Ù„Ø£ÙƒÙ„ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„Ø­ØµØ©',emoji:'ğŸ”'},
];

const FEEDBACK_TYPES = [
  {id:'suggestion', label:'ğŸ’¡ Ø§Ù‚ØªØ±Ø§Ø­'},
  {id:'complaint', label:'ğŸ“¢ Ù…Ù„Ø§Ø­Ø¸Ø©'},
  {id:'thanks', label:'ğŸŒŸ Ø´ÙƒØ± ÙˆØªÙ‚Ø¯ÙŠØ±'},
  {id:'question', label:'â“ Ø§Ø³ØªÙØ³Ø§Ø±'},
];

let selectedClassId=null, selectedClassLabel='', unsubscribe=null;
let currentStudents=[], currentGroups=[], currentSid='';
let currentStudentName='', selectedFeedbackType='suggestion';

window.selectLoginClass=function(id,label,el){
  selectedClassId=id; selectedClassLabel=label;
  document.querySelectorAll('.class-opt').forEach(e=>e.classList.remove('selected'));
  el.classList.add('selected');
  document.getElementById('loginErr').textContent='';
};

window.loginParent=function(){
  const sid=document.getElementById('sidInput').value.trim();
  const err=document.getElementById('loginErr');
  if(!selectedClassId){err.textContent='Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙØµÙ„ Ø£ÙˆÙ„Ø§Ù‹!';return;}
  if(!sid){err.textContent='Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø¥Ø¯Ø®Ø§Ù„ Ø±Ù‚Ù… Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¯Ù†ÙŠ!';return;}
  currentSid=sid;
  document.getElementById('loginScreen').style.display='none';
  document.getElementById('studentView').style.display='block';
  document.getElementById('studentContent').innerHTML='<div class="loading"><div class="spinner"></div>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>';

  if(unsubscribe)unsubscribe();
  unsubscribe=onSnapshot(doc(db,'classes',selectedClassId),snap=>{
    if(snap.exists()){const d=snap.data();currentStudents=d.students||[];currentGroups=d.groups||[];}
    else{currentStudents=[];currentGroups=[];}
    renderStudent();
  },()=>{
    document.getElementById('studentContent').innerHTML='<div class="loading">Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª</div>';
  });
};

window.goBack=function(){
  if(unsubscribe){unsubscribe();unsubscribe=null;}
  document.getElementById('studentView').style.display='none';
  document.getElementById('loginScreen').style.display='block';
  document.getElementById('sidInput').value='';
  document.getElementById('loginErr').textContent='';
  currentStudentName='';
};

window.selectFeedbackType=function(typeId,btn){
  selectedFeedbackType=typeId;
  document.querySelectorAll('.feedback-type-btn').forEach(b=>b.classList.remove('active'));
  btn.classList.add('active');
};

window.submitFeedback=async function(){
  const textarea=document.getElementById('feedbackText');
  const text=textarea.value.trim();
  const submitBtn=document.getElementById('feedbackSubmitBtn');
  const successMsg=document.getElementById('feedbackSuccess');
  if(!text){showToast('Ø§ÙƒØªØ¨ Ø±Ø£ÙŠÙƒ Ø£Ùˆ Ø§Ù‚ØªØ±Ø§Ø­Ùƒ Ø£ÙˆÙ„Ø§Ù‹!',true);return;}
  if(text.length<5){showToast('Ø§Ù„Ø±Ø¬Ø§Ø¡ ÙƒØªØ§Ø¨Ø© ØªÙØ§ØµÙŠÙ„ Ø£ÙƒØ«Ø±',true);return;}
  submitBtn.disabled=true;
  submitBtn.textContent='Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø¥Ø±Ø³Ø§Ù„...';
  try{
    await addDoc(collection(db,'feedbacks'),{
      studentName:currentStudentName,
      studentSid:currentSid,
      classId:selectedClassId,
      classLabel:selectedClassLabel,
      type:selectedFeedbackType,
      typeLabel:FEEDBACK_TYPES.find(t=>t.id===selectedFeedbackType)?.label||'ğŸ’¡ Ø§Ù‚ØªØ±Ø§Ø­',
      text:text,
      createdAt:Date.now(),
      createdDate:new Date().toLocaleDateString('ar-SA',{year:'numeric',month:'long',day:'numeric'})
    });
    textarea.value='';
    successMsg.classList.add('show');
    showToast('ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø£ÙŠÙƒ Ø¨Ù†Ø¬Ø§Ø­ âœ…');
    setTimeout(()=>successMsg.classList.remove('show'),4000);
    loadPreviousFeedbacks();
  }catch(e){
    showToast('Ø­Ø¯Ø« Ø®Ø·Ø£ØŒ Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø«Ø§Ù†ÙŠØ©',true);
    console.error(e);
  }finally{
    submitBtn.disabled=false;
    submitBtn.textContent='Ø¥Ø±Ø³Ø§Ù„ ğŸ“¨';
  }
};

async function loadPreviousFeedbacks(){
  const container=document.getElementById('prevFeedbacks');
  if(!container)return;
  try{
    const q=query(collection(db,'feedbacks'),where('studentSid','==',currentSid),where('classId','==',selectedClassId));
    const snap=await getDocs(q);
    const feedbacks=[];
    snap.forEach(d=>feedbacks.push(d.data()));
    feedbacks.sort((a,b)=>b.createdAt-a.createdAt);
    if(!feedbacks.length){container.innerHTML='<div class="fb-empty">Ù„Ù… ØªØ±Ø³Ù„ Ø£ÙŠ Ø¢Ø±Ø§Ø¡ Ø³Ø§Ø¨Ù‚Ø© Ø¨Ø¹Ø¯</div>';return;}
    container.innerHTML=feedbacks.map(fb=>`
      <div class="fb-item">
        <span class="fb-item-type">${fb.typeLabel||'ğŸ’¡ Ø§Ù‚ØªØ±Ø§Ø­'}</span>
        <div class="fb-item-text">${fb.text}</div>
        <div class="fb-item-date">ğŸ“… ${fb.createdDate||''}</div>
      </div>`).join('');
  }catch(e){
    container.innerHTML='<div class="fb-empty">ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¢Ø±Ø§Ø¡ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©</div>';
  }
}

function showToast(msg,err=false){
  const t=document.getElementById('toast');
  t.textContent=msg;t.className='toast show'+(err?' error':'');
  setTimeout(()=>t.classList.remove('show'),2500);
}

function renderStudent(){
  const el=document.getElementById('studentContent');
  const student=currentStudents.find(s=>s.sid===currentSid);
  if(!student){
    el.innerHTML=`<div class="loading"><div style="font-size:3rem;margin-bottom:1rem">ğŸ˜•</div>Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø·Ø§Ù„Ø¨ Ø¨Ù‡Ø°Ø§ Ø§Ù„Ø±Ù‚Ù…<br><span style="font-size:0.82rem;color:var(--muted)">ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­Ø© Ø§Ù„ÙØµÙ„ ÙˆØ±Ù‚Ù… Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ù…Ø¯Ù†ÙŠ</span></div>`;
    return;
  }
  currentStudentName=student.name;
  const sorted=[...currentStudents].sort((a,b)=>b.points-a.points);
  const rank=sorted.findIndex(s=>s.sid===currentSid)+1;
  const medals=['ğŸ¥‡','ğŸ¥ˆ','ğŸ¥‰'];
  const rankLabel=medals[rank-1]||`#${rank}`;
  const grp=currentGroups.find(g=>g.members.includes(student.id));
  const behaviors=(student.behaviors||[]).map(bid=>{
    const b=BB.find(b=>b.id===bid);
    return b?`<div class="bhv-item"><span class="bhv-emoji">${b.emoji}</span><span class="bhv-text">${b.label}</span></div>`:'';
  }).join('');
  const feedbackTypeBtns=FEEDBACK_TYPES.map(t=>
    `<button class="feedback-type-btn ${t.id==='suggestion'?'active':''}" onclick="selectFeedbackType('${t.id}',this)">${t.label}</button>`
  ).join('');

  el.innerHTML=`
    <div class="student-hero">
      <div class="hero-name">${student.name}</div>
      <div class="hero-class">ğŸ“š ${selectedClassLabel}</div>
      <div><span class="live-badge"><div class="live-dot"></div>Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¨Ø§Ø´Ø±Ø©</span></div>
      ${renderBadges(student,currentStudents)}
    </div>
    <div class="stats-cards">
      <div class="stat-card gold">
        <div class="stat-num gold">${student.points}</div>
        <div class="stat-label">Ø§Ù„Ù†Ù‚Ø§Ø· Ø§Ù„Ø¹Ø§Ù…Ø©</div>
      </div>
      <div class="stat-card green">
        <div class="stat-num green">${student.bhvPoints||0}</div>
        <div class="stat-label">Ù†Ù‚Ø§Ø· Ø§Ù„Ø³Ù„ÙˆÙƒ Ø§Ù„Ø¬ÙŠØ¯ ğŸ˜‡</div>
      </div>
    </div>
    <div class="section-card" style="text-align:center;">
      <h3>ğŸ† Ø§Ù„ØªØ±ØªÙŠØ¨ ÙÙŠ Ø§Ù„ÙØµÙ„</h3>
      <div class="rank-badge">${rankLabel} Ù…Ù† ${currentStudents.length} Ø·Ø§Ù„Ø¨</div>
    </div>
    ${grp?`<div class="section-card">
      <h3>ğŸ«‚ Ø§Ù„Ù…Ø¬Ù…ÙˆØ¹Ø©</h3>
      <div class="group-display">
        <div class="group-dot" style="background:${grp.color}"></div>
        <div class="group-name">${grp.name}</div>
      </div>
    </div>`:''}
    <div class="section-card">
      <h3>âš ï¸ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø§Ù„Ø³Ù„ÙˆÙƒ</h3>
      ${behaviors||'<div class="empty-note">âœ… Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ù„Ø§Ø­Ø¸Ø§Øª Ø³Ù„ÙˆÙƒÙŠØ©</div>'}
    </div>
    <div class="notif-section" id="notifSection">
      <h3>ğŸ”” Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø§Ù„ØªÙ…ÙŠØ²</h3>
      <div id="notifList"><div class="notif-empty">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div></div>
    </div>
    <div class="feedback-section">
      <h3>ğŸ’¬ Ø¢Ø±Ø§Ø¡ ÙˆØ§Ù‚ØªØ±Ø§Ø­Ø§Øª ÙˆÙ„ÙŠ Ø§Ù„Ø£Ù…Ø±</h3>
      <div style="font-size:0.8rem;color:var(--muted);margin-bottom:0.7rem;">Ø±Ø£ÙŠÙƒ ÙŠÙ‡Ù…Ù†Ø§! Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø£ÙŠÙƒ Ù…Ø±ØªØ¨Ø·Ø§Ù‹ Ø¨Ø­Ø³Ø§Ø¨ Ø§Ù„Ø·Ø§Ù„Ø¨ <span style="color:var(--accent);font-weight:700;">${student.name}</span></div>
      <div class="feedback-type-row">${feedbackTypeBtns}</div>
      <textarea class="feedback-textarea" id="feedbackText" placeholder="Ø§ÙƒØªØ¨ Ø±Ø£ÙŠÙƒ Ø£Ùˆ Ø§Ù‚ØªØ±Ø§Ø­Ùƒ Ù‡Ù†Ø§..."></textarea>
      <button class="feedback-submit" id="feedbackSubmitBtn" onclick="submitFeedback()">Ø¥Ø±Ø³Ø§Ù„ ğŸ“¨</button>
      <div class="feedback-success" id="feedbackSuccess">âœ… ØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø±Ø£ÙŠÙƒ Ø¨Ù†Ø¬Ø§Ø­ØŒ Ø´ÙƒØ±Ø§Ù‹ Ù„Ùƒ!</div>
      <div class="prev-feedbacks">
        <div class="prev-feedbacks-title">ğŸ“‹ Ø¢Ø±Ø§Ø¤Ùƒ Ø§Ù„Ø³Ø§Ø¨Ù‚Ø©:</div>
        <div id="prevFeedbacks"><div class="fb-empty">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div></div>
      </div>
    </div>
  `;
  loadPreviousFeedbacks();
  loadNotifications();
}

async function loadNotifications(){
  const container=document.getElementById('notifList');
  if(!container)return;
  try{
    const q=query(
      collection(db,'notifications'),
      where('studentSid','==',currentSid),
      where('classId','==',selectedClassId),
      orderBy('createdAt','desc'),
      limit(10)
    );
    const snap=await getDocs(q);
    const notifs=[];
    snap.forEach(d=>notifs.push({...d.data(),docId:d.id}));
    if(!notifs.length){
      container.innerHTML='<div class="notif-empty">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¥Ø´Ø¹Ø§Ø±Ø§Øª Ø¨Ø¹Ø¯ ğŸŒ±</div>';
      return;
    }
    container.innerHTML=notifs.map(n=>{
      let emoji='ğŸ””', text='';
      if(n.type==='badge'){
        emoji=n.data?.emoji||'ğŸ–ï¸';
        text=`Ø­ØµÙ„Øª Ø¹Ù„Ù‰ Ø´Ø§Ø±Ø© ${n.data?.emoji||''} <strong>${n.data?.label||''}</strong>`;
      } else if(n.type==='milestone'){
        emoji='ğŸŒŸ';
        text=`ÙˆØµÙ„Øª Ø¥Ù„Ù‰ <strong>${n.data?.points||''} Ù†Ù‚Ø·Ø©</strong> ğŸ‰`;
      }
      return `<div class="notif-item ${n.read?'':'unread'}">
        <div class="notif-emoji">${emoji}</div>
        <div class="notif-text">
          <div>Ø£Ø­Ø³Ù†Øª ÙŠØ§ ${n.studentName}! ${text}</div>
          <div class="notif-date">ğŸ“… ${n.createdDate||''}</div>
        </div>
      </div>`;
    }).join('');
  }catch(e){
    container.innerHTML='<div class="notif-empty">ØªØ¹Ø°Ø± ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø¥Ø´Ø¹Ø§Ø±Ø§Øª</div>';
  }
}

</script>
</body>
</html>
